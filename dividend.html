<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미국 주식 배당 중심 장기 포트폴리오</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .section-header {
            border-left: 5px solid #06b6d4; /* Cyan 500 */
            padding-left: 1rem;
            font-weight: 700;
            color: #0f172a;
        }
        .analysis-button {
            transition: all 0.15s ease-in-out;
        }
        .analysis-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <script type="module">
        // Firebase is initialized but not used for this LLM feature. Included for standard environment setup.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication using the provided token or anonymously
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                }
            })();
        }

        /**
         * LLM API 호출을 위한 지수 백오프 기반 Fetch 함수
         * @param {string} url - API URL
         * @param {object} options - Fetch 옵션
         * @param {number} maxRetries - 최대 재시도 횟수
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // 429 Too Many Requests에 대해서만 재시도
                        if (response.status === 429 && i < maxRetries - 1) {
                            throw new Error('Too Many Requests, Retrying...');
                        }
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if (error.message.includes('Too Many Requests') && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw error;
                }
            }
            throw new Error('API request failed after multiple retries.');
        }


        // Gemini API 호출 함수
        window.fetchTickerAnalysis = async (ticker) => {
            const container = document.getElementById('llm-analysis-container');
            const outputDiv = document.getElementById('analysis-output');
            const sourcesDiv = document.getElementById('analysis-sources');
            const tickerSpan = document.getElementById('analysis-ticker');
            
            // UI 초기화 및 로딩 표시
            container.classList.remove('hidden');
            tickerSpan.textContent = ticker;
            outputDiv.innerHTML = '<div class="flex items-center space-x-2 text-blue-600"><svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>최신 정보를 분석 중입니다...</span></div>';
            sourcesDiv.innerHTML = '';
            
            const systemPrompt = "You are a world-class financial analyst and portfolio strategist. Provide a concise, single-paragraph summary of the key findings based on the search results. Include the current dividend yield and briefly analyze its role (stability, income, or growth) in a long-term dividend growth portfolio. Respond professionally in Korean.";
            const userQuery = `${ticker}의 최신 주요 정보, 현재 배당률, 그리고 장기 배당 성장 포트폴리오 내에서의 역할에 대한 간결한 전문가 분석을 제공해 주세요. 실시간 데이터를 사용하세요.`;
            
            const apiKey = ""; // Canvas will provide this if empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Google Search Grounding 사용
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // 결과 렌더링
                    outputDiv.innerHTML = `<p>${text}</p>`;

                    if (sources.length > 0) {
                        let sourcesHtml = '<strong>출처 정보:</strong><ul class="list-disc ml-4 mt-1 space-y-0.5">';
                        sources.forEach(source => {
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:underline">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</ul>';
                        sourcesDiv.innerHTML = sourcesHtml;
                    } else {
                        sourcesDiv.innerHTML = '출처 정보가 제공되지 않았습니다.';
                    }

                } else {
                    outputDiv.innerHTML = '<p class="text-red-600">분석 결과를 가져오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.</p>';
                    sourcesDiv.innerHTML = '';
                }

            } catch (error) {
                console.error("Gemini API Call Error:", error);
                outputDiv.innerHTML = `<p class="text-red-600">API 호출 중 오류 발생: ${error.message}</p>`;
                sourcesDiv.innerHTML = '';
            }
        };

    </script>

    <!-- Header Section -->
    <header class="text-center mb-10 p-6 bg-white shadow-xl rounded-xl">
        <h1 class="text-4xl font-extrabold text-[#1e40af] sm:text-5xl mb-2">
            미국 주식 배당 중심 장기 포트폴리오
        </h1>
        <p class="text-xl text-gray-600 font-medium">
            Dividend Stability with Selective Growth Engine
        </p>
    </header>

    <div class="space-y-12 max-w-6xl mx-auto">

        <!-- ===== SECTION 1: 포트폴리오 구조 및 목표 ===== -->
        <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-cyan-500">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">
                1. 포트폴리오 구조 및 핵심 목표
            </h2>

            <!-- 90/10 시각화 -->
            <div class="mb-8">
                <h3 class="text-2xl font-semibold mb-4 section-header">
                    📊 배당 안정성 (90%) + 성장 옵션 (10%)
                </h3>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 p-4 bg-gray-50 rounded-lg">
                    <div class="w-full sm:w-1/3 text-center">
                        <div class="h-8 rounded-full flex overflow-hidden shadow-inner">
                            <div class="bg-blue-600 flex-1" style="width: 90%;"></div>
                            <div class="bg-red-500" style="width: 10%;"></div>
                        </div>
                        <p class="text-sm mt-2 text-gray-600">배당 안정성 90% vs 성장 옵션 10%</p>
                    </div>
                    <div class="w-full sm:w-2/3">
                        <p class="text-lg font-medium text-gray-700">
                            **핵심 원칙:** 장기 보유를 위한 **배당 기반 안정성(90%)**을 유지하며, 통제된 **고성장(10%)**으로 초과 수익을 추구합니다.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 자산 배분 테이블 -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-3 section-header">
                    1-1. 자산 배분 (Portfolio Allocation)
                </h3>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">자산 (티커)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">역할</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">비중</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">주요 특징</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">분석 ✨</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-semibold text-blue-800">SCHD</td>
                                <td class="px-4 py-3 whitespace-nowrap">안정성 / 성장</td>
                                <td class="px-4 py-3 whitespace-nowrap font-bold text-lg text-green-600">50%</td>
                                <td class="px-4 py-3">배당성장 핵심, 장기 안정성</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="fetchTickerAnalysis('SCHD')" class="analysis-button bg-cyan-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-cyan-600 shadow-md">분석 ✨</button>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-semibold text-blue-700">JEPQ</td>
                                <td class="px-4 py-3 whitespace-nowrap">현금 흐름</td>
                                <td class="px-4 py-3 whitespace-nowrap font-bold">20%</td>
                                <td class="px-4 py-3">월배당 창출, 안정적 현금 흐름</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="fetchTickerAnalysis('JEPQ')" class="analysis-button bg-cyan-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-cyan-600 shadow-md">분석 ✨</button>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-semibold text-blue-700">Realty Income (O)</td>
                                <td class="px-4 py-3 whitespace-nowrap">실물 기반 배당</td>
                                <td class="px-4 py-3 whitespace-nowrap font-bold">20%</td>
                                <td class="px-4 py-3">실물 기반 월배당, 앵커 배당</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="fetchTickerAnalysis('Realty Income O')" class="analysis-button bg-cyan-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-cyan-600 shadow-md">분석 ✨</button>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-semibold text-red-600">NVDA</td>
                                <td class="px-4 py-3 whitespace-nowrap">성장 옵션</td>
                                <td class="px-4 py-3 whitespace-nowrap font-bold">10%</td>
                                <td class="px-4 py-3">통제된 비중으로 초과 수익 추구</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="fetchTickerAnalysis('NVDA')" class="analysis-button bg-cyan-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-cyan-600 shadow-md">분석 ✨</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gemini Analysis Output Area -->
            <div id="llm-analysis-container" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <h4 class="text-xl font-bold text-blue-800 mb-3">✨ <span id="analysis-ticker"></span> 티커 분석 결과</h4>
                <div id="analysis-output" class="text-gray-700 space-y-3 min-h-[50px]"></div>
                <div id="analysis-sources" class="mt-4 text-xs text-gray-500 border-t pt-2"></div>
            </div>
            <!-- End Gemini Analysis Output Area -->

            <!-- 예상 수익률 및 목표 -->
            <div>
                <h3 class="text-xl font-semibold mb-3 section-header">
                    1-2. 예상 수익률 및 장기 목표
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 예상 수익률 -->
                    <div class="p-5 bg-teal-50 border-l-4 border-teal-500 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-teal-800 mb-2 flex items-center">
                            📈 예상 수익률 (Estimated Returns)
                        </h4>
                        <ul class="list-disc ml-5 space-y-1 text-gray-700">
                            <li>**예상 연배당률:** <span class="text-xl font-extrabold text-green-700">약 4.2%</span> (실질적 안정성 확보)</li>
                            <li>**예상 연평균 성장률 (CAGR):** <span class="text-xl font-extrabold text-blue-700">약 9~11%</span> (장기 시장 평균 기대치)</li>
                        </ul>
                    </div>
                    <!-- 핵심 목표 -->
                    <div class="p-5 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-yellow-800 mb-2 flex items-center">
                            ✅ 핵심 목표
                        </h4>
                        <ol class="list-decimal ml-5 space-y-1 text-gray-700">
                            <li>**현금 흐름:** 배당을 통한 실질적이고 안정적인 현금 확보.</li>
                            <li>**장기 보유:** 하락장에서도 유지 가능한 **'마음 편한'** 장기 구조.</li>
                            <li>**리스크 통제:** 성장주는 **통제된 10% 비중**으로만 편입.</li>
                        </ol>
                    </div>
                </div>
            </div>

        </section>

        <!-- ===== SECTION 2: 장기 운영 전략 및 결론 ===== -->
        <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-indigo-500">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">
                2. 장기 운영 전략 및 결론
            </h2>

            <!-- 리밸런싱 전략 -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-3 section-header">
                    🛡️ 규칙 기반 리밸런싱 전략 (Risk Control)
                </h3>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">시나리오</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">리밸런싱 실행 계획</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">목표 및 목적</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-medium text-indigo-800">정기 리밸런싱</td>
                                <td class="px-4 py-3 whitespace-nowrap">연 1회 실시 (필요 시 추가 실시)</td>
                                <td class="px-4 py-3">**수익 극대화가 아닌 리스크 통제**</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-medium text-red-600">강세장 (성장주 급등)</td>
                                <td class="px-4 py-3">NVDA 초과분 매도 → **SCHD / 현금**으로 재배치</td>
                                <td class="px-4 py-3">이익 실현 및 안정성 강화</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap font-medium text-blue-600">경기 침체/하락장</td>
                                <td class="px-4 py-3">배당률 높은 자산으로 재투자 (배당 재무 확인)</td>
                                <td class="px-4 py-3">하락장 방어 및 배당 재투자 기회 확보</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="mt-3 text-sm text-gray-600">**리밸런싱 원칙:** 배당 재투자는 SCHD / O / JEPQ 등 배당 구조 강화에 집중합니다.</p>
            </div>

            <!-- 결론 -->
            <div>
                <h3 class="text-xl font-semibold mb-4 section-header">
                    ✅ 결론: 장기 생존을 위한 통제 장치
                </h3>
                <div class="p-6 bg-gray-100 rounded-lg shadow-inner">
                    <blockquote class="text-xl italic font-medium text-gray-800 border-l-4 border-green-500 pl-4 mb-4">
                        "리밸런싱은 수익을 늘리기 위한 전략이 아니라, 장기 생존을 위한 통제 장치이다."
                    </blockquote>
                    <ul class="list-disc ml-6 space-y-2 text-gray-700">
                        <li>**강점:** 안정적인 **배당 현금흐름**과 통제된 **성장 옵션**의 균형.</li>
                        <li>**기대 효과:** 시장 변동성에 흔들리지 않는 **지속 가능한 투자 환경** 조성.</li>
                        <li>**운영 방향:** 규칙 기반 운영을 통해 변수(감정적 판단)를 제거하고 포트폴리오를 지속적으로 관리.</li>
                    </ul>
                </div>
            </div>

        </section>

    </div>

    <!-- Footer for context -->
    <footer class="text-center mt-10 p-4 text-sm text-gray-500">
        자료 출처: 포트폴리오 분석 데이터 기반 재구성
    </footer>

</body>
</html>